### Neuland App Backend — Agents Guide

This document helps AI agents quickly understand the stack, structure, and common workflows of this repository so you can make safe, effective edits.

## Stack Overview
- **Runtime**: Bun 1.x, TypeScript (ESNext, strict)
- **Web Server**: Express 5
- **GraphQL**: Apollo Server 5, schema-first (SDL files in `src/schema/`), resolvers in `src/`
- **DB Layer**: PostgreSQL (local via Docker), `drizzle-orm` with `postgres` driver; migrations via `drizzle-kit`
- **Caching**: `node-cache` in-process
- **Docs**: Static docs/playground generated with Magidoc, served from `docs/out`
- **Tooling**: Biome (lint/format), GraphQL Codegen (schema artifacts), GraphQLSP TS plugin

## Key Entry Points
- `index.ts` — bootstraps Express + Apollo Server.
  - Loads SDL from `src/schema/{enums,scalars,types,inputs,schema}.gql`
  - Registers `resolvers` from `src/resolvers.ts`
  - Exposes GraphQL at `/graphql` and serves docs from `/`
- `src/resolvers.ts` — root resolvers map for Query and Mutation.
- `src/db/index.ts` — initializes Drizzle with `postgres` using env-configured connection string.

## Endpoints
- GraphQL: `POST http://localhost:4000/graphql`
- Local docs/playground: `http://localhost:4000/`

## Scripts (package.json)
- `bun start` — run server
- `bun dev` — run with hot reload
- `bun migrate` — run pending migrations
- `bun db:generate` — generate migrations from schema
- `bun codegen` — GraphQL codegen (uses `codegen.ts`)
- `bun lint` / `bun fmt` — Biome lint and format
- `bun docs:dev` — run Magidoc locally for docs

## Directory Map (high-signal only)
- `index.ts` — server bootstrap
- `src/schema/` — SDL schema files (split by concern)
- `src/resolvers.ts` — resolvers registry and custom scalars
- `src/queries/` — query resolvers
- `src/mutations/` — mutation resolvers (CRUD, upserts, etc.)
- `src/db/schema/` — Drizzle table definitions
- `src/db/migrations/` — SQL migrations generated by drizzle-kit
- `src/__generated__/` — GraphQL codegen outputs (schema and helpers)
- `src/utils/` — helpers (auth, dates, scraping, etc.)
- `src/scraping/` — scrapers for upstream data sources
- `docs/` — Magidoc config and generated static site under `docs/out`

## Configuration
- TypeScript: `tsconfig.json` sets `paths` aliases — use `@/*` to import from `src/*` and `@/index` for `index.ts`
- Lint/Format: `biome.jsonc` (tabs, single quotes, no semicolons)
- Drizzle Kit: `drizzle.config.ts` (schema path, out dir, DB creds)
- Docker: `Dockerfile` (multi-stage with docs prebuild), `docker-compose.yml` for local Postgres + app

## Environment Variables (common)
- `PORT` (default 4000)
- `DB_HOST` (local dev: `localhost`, Docker: `postgres`)
- `DB_PORT` (default `5432`)
- `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB` (defaults in compose: `postgres`/`postgres`/`app`)

## Authentication Context
- Requests with `Authorization: Bearer <token>` are decoded by `src/utils/auth-utils.ts` via `getUserFromToken`. The decoded payload (if present) is available on GraphQL context as `jwtPayload` and is used by resolvers that require auth.

## Data and Caching
- DB access via `db` from `src/db/index.ts` (Drizzle). Prefer using typed schema from `src/db/schema/*`.
- In-process cache with `NodeCache` exported from `index.ts` as `cache` (TTL 10 min). Use sparingly for frequently-read, rarely-changing data.

## How to Add/Change Things

### Add a new Query
1. Define types in SDL: add to `src/schema/types.gql` if needed and field to `src/schema/schema.gql` under `type Query`.
2. Implement resolver in `src/queries/<name>.ts`.
3. Register in `src/resolvers.ts` under `Query` map.
4. If DB-backed, add/select using Drizzle via `src/db/schema/*` and `db`.

### Add a new Mutation
1. Define input/return types in `src/schema/inputs.gql` and `types.gql`; add field to `src/schema/schema.gql` under `type Mutation`.
2. Implement in `src/mutations/<domain>/<action>.ts` (follow existing patterns like `upsert.ts`, `delete.ts`).
3. Register in `src/resolvers.ts` under `Mutation` map.
4. If schema changes require DB updates, see migrations below.

### Add/Change Database Tables
1. Create or edit table in `src/db/schema/<table>.ts` using Drizzle.
2. Generate migration: `bun db:generate` (uses `drizzle.config.ts`).
3. Apply migration: `bun migrate`.
4. Use the new table in resolvers via `db` and typed schema.

### Add a Scraper / External Data Source
1. Place new scraper in `src/scraping/<source>.ts` (see existing scrapers for conventions).
2. Sanitize/shape data to match GraphQL types.
3. Optionally cache results via `cache` if rate-limited or expensive.

### Docs and Schema Artifacts
- Docs are generated at build with `bunx magidoc generate -f docs/magidoc.mjs` (Dockerfile runs this); locally use `bun docs:dev`.
- GraphQL codegen uses `codegen.ts` and outputs under `src/__generated__`. Run `bun codegen` after SDL changes if consumers depend on artifacts.

## Local Development
1. Install: `bun i`
2. Run Postgres: `docker compose up postgres -d`
3. Migrate: `bun migrate`
4. Start server: `bun dev` (hot reload) or `bun start`
5. Playground: open `http://localhost:4000/`

## Deployment Notes
- Docker image is multi-stage; final image copies compiled sources and prebuilt docs. Entrypoint `startup.sh` launches the server as user `bun`. Port 4000 is exposed.

## Conventions & Gotchas
- Use `@/*` imports (bundler resolution); do not use relative deep paths.
- Keep SDL authoritative; resolvers must align with schema and validations.
- Maintain auth checks in resolvers that access protected resources.
- Respect Biome style: tabs for indentation, single quotes, and minimal semicolons.
- Prefer early returns and clear naming per repository style.

## Where Things Live (examples)
- GraphQL:
  - SDL root fields: `src/schema/schema.gql`
  - Scalars/enums: `src/schema/scalars.gql`, `src/schema/enums.gql`
  - Resolvers map: `src/resolvers.ts`
  - Queries: `src/queries/*`, Mutations: `src/mutations/*`
- Database:
  - Drizzle schema: `src/db/schema/*`
  - Client and connection string: `src/db/index.ts`
  - Migrations: `src/db/migrations/*`
- Utilities: `src/utils/*` (auth, dates, parsing, translation, etc.)
- Docs config: `docs/magidoc.mjs`; output served from `docs/out`

## CI/Linting
- Biome checks can be run with `bun lint` and fixed with `bun fmt`. Commit hooks or CI workflows may enforce these rules. Keep TypeScript strict and avoid unused imports/variables.

If you’re an automated agent planning changes, prefer small, focused edits and update SDL, resolvers, and DB schema together to keep the system consistent. Test locally against the playground before committing.

 